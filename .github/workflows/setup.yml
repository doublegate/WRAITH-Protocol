---
# Reusable Workflow: Common Setup Steps
#
# This reusable workflow provides common setup for Rust and Node.js development
# across Linux, macOS, and Windows platforms. It reduces duplication across
# CI, release, and other workflows.
#
# Usage:
#   jobs:
#     build:
#       uses: ./.github/workflows/setup.yml
#       with:
#         os: ubuntu-latest
#         rust-toolchain: stable
#         node-version: '22'
#         install-tauri: true

name: Setup

on:
  workflow_call:
    inputs:
      os:
        description: 'Operating system (ubuntu-latest, macos-latest, windows-latest)'
        required: true
        type: string
      rust-toolchain:
        description: 'Rust toolchain version (stable, nightly, 1.88, etc.)'
        required: false
        type: string
        default: 'stable'
      rust-components:
        description: 'Rust components to install (comma-separated: clippy,rustfmt)'
        required: false
        type: string
        default: ''
      rust-targets:
        description: 'Rust targets to install (comma-separated)'
        required: false
        type: string
        default: ''
      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '22'
      install-node:
        description: 'Install Node.js and npm'
        required: false
        type: boolean
        default: false
      install-tauri:
        description: 'Install Tauri CLI and system dependencies'
        required: false
        type: boolean
        default: false
      cache-key-suffix:
        description: 'Suffix for cache key differentiation'
        required: false
        type: string
        default: ''

env:
  CARGO_TERM_COLOR: always

jobs:
  setup:
    name: Setup Environment
    runs-on: ${{ inputs.os }}
    outputs:
      cache-hit-cargo: ${{ steps.cache-cargo.outputs.cache-hit }}
      cache-hit-node: ${{ steps.cache-node.outputs.cache-hit }}

    steps:
      #########################################################################
      # System Dependencies
      #########################################################################
      - name: Install system dependencies (Ubuntu)
        if: inputs.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsqlcipher-dev \
            libasound2-dev

      - name: Install system dependencies (macOS)
        if: inputs.os == 'macos-latest'
        run: |
          brew install sqlcipher opus

      - name: Install system dependencies (Windows)
        if: inputs.os == 'windows-latest'
        shell: pwsh
        run: |
          # Install SQLCipher using vcpkg
          vcpkg install sqlcipher:x64-windows

      - name: Set SQLCipher environment (Windows)
        if: inputs.os == 'windows-latest'
        shell: pwsh
        run: |
          $VCPKG_ROOT = "C:\vcpkg"
          echo "SQLCIPHER_LIB_DIR=$VCPKG_ROOT\installed\x64-windows\lib" >> $env:GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=$VCPKG_ROOT\installed\x64-windows\include" >> $env:GITHUB_ENV

      #########################################################################
      # Rust Toolchain
      #########################################################################
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.rust-toolchain }}
          components: ${{ inputs.rust-components }}
          targets: ${{ inputs.rust-targets }}

      - name: Cache Cargo registry and target
        id: cache-cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: >-
            ${{ inputs.os }}-cargo-${{ inputs.rust-toolchain }}-
            ${{ inputs.cache-key-suffix }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ inputs.os }}-cargo-${{ inputs.rust-toolchain }}-${{ inputs.cache-key-suffix }}-
            ${{ inputs.os }}-cargo-${{ inputs.rust-toolchain }}-
            ${{ inputs.os }}-cargo-

      #########################################################################
      # Node.js (optional)
      #########################################################################
      - name: Setup Node.js
        if: inputs.install-node || inputs.install-tauri
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Cache Node modules
        if: inputs.install-node || inputs.install-tauri
        id: cache-node
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            clients/*/node_modules
            clients/*/frontend/node_modules
          key: >-
            ${{ inputs.os }}-node-${{ inputs.node-version }}-
            ${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ inputs.os }}-node-${{ inputs.node-version }}-
            ${{ inputs.os }}-node-

      #########################################################################
      # Tauri CLI (optional)
      #########################################################################
      - name: Install Tauri CLI
        if: inputs.install-tauri
        run: npm install -g @tauri-apps/cli@^2.0.0
