---
# WRAITH Protocol CI Workflow
#
# Runs on every push to main/develop and on pull requests.
# Includes cross-platform testing matrix for Linux, macOS, and Windows.
#
# Jobs:
# 1. check - Basic compilation check (fast gate)
# 2. fmt - Formatting check (fast gate, no deps)
# 3. test - Cross-platform test matrix (Linux, macOS, Windows)
# 4. clippy - Linting
# 5. docs - Documentation build
# 6. msrv - Minimum Supported Rust Version check
# 7. coverage - Code coverage report
#
# Optimization notes:
# - fmt runs immediately (no system deps, fast)
# - check runs as early gate before expensive test matrix
# - clippy depends on check to reuse build artifacts
# - Caching is optimized with proper restore-keys fallback

name: CI

"on":
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/docs.yml'
      - '.github/workflows/mdbook-gh-pages.yml'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/docs.yml'
      - '.github/workflows/mdbook-gh-pages.yml'

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings
  # Exclude Tauri clients from protocol-level CI (they have their own builds)
  EXCLUDE_CLIENTS: >-
    --exclude wraith-transfer
    --exclude wraith-chat
    --exclude wraith-sync
    --exclude wraith-share
    --exclude wraith-stream
    --exclude wraith-mesh
    --exclude wraith-publish
    --exclude wraith-vault

jobs:
  #############################################################################
  # Fast Gates (run first, fail fast)
  #############################################################################
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsqlcipher-dev \
            libasound2-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-check-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-check-
            ${{ runner.os }}-cargo-

      - name: Check compilation
        run: cargo check --workspace --all-features $EXCLUDE_CLIENTS

  #############################################################################
  # Cross-Platform Test Matrix
  #############################################################################
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [fmt, check]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            test_flags: ""
            cache_suffix: "linux"
          - os: macos-latest
            test_flags: ""
            cache_suffix: "macos"
          - os: windows-latest
            # Windows needs lower parallelism due to resource constraints
            test_flags: "-- --test-threads=2"
            cache_suffix: "windows"

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsqlcipher-dev \
            libasound2-dev

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install sqlcipher opus

      - name: Install system dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          vcpkg install sqlcipher:x64-windows

      - name: Set SQLCipher environment (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $VCPKG_ROOT = "C:\vcpkg"
          echo "SQLCIPHER_LIB_DIR=$VCPKG_ROOT\installed\x64-windows\lib" >> $env:GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=$VCPKG_ROOT\installed\x64-windows\include" >> $env:GITHUB_ENV

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-
            ${{ runner.os }}-cargo-check-
            ${{ runner.os }}-cargo-

      - name: Run tests
        run: >-
          cargo test --workspace --all-features
          --exclude wraith-transfer
          --exclude wraith-chat
          --exclude wraith-sync
          --exclude wraith-share
          --exclude wraith-stream
          --exclude wraith-mesh
          --exclude wraith-publish
          --exclude wraith-vault
          ${{ matrix.test_flags }}
        shell: bash

  #############################################################################
  # Static Analysis
  #############################################################################
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsqlcipher-dev \
            libasound2-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo registry and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-clippy-
            ${{ runner.os }}-cargo-check-
            ${{ runner.os }}-cargo-

      - name: Clippy
        run: >-
          cargo clippy --workspace --all-features
          --exclude wraith-transfer
          --exclude wraith-chat
          --exclude wraith-sync
          --exclude wraith-share
          --exclude wraith-stream
          --exclude wraith-mesh
          --exclude wraith-publish
          --exclude wraith-vault
          -- -D warnings

  #############################################################################
  # Documentation
  #############################################################################
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsqlcipher-dev \
            libasound2-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-
            ${{ runner.os }}-cargo-check-
            ${{ runner.os }}-cargo-

      - name: Build documentation
        run: >-
          cargo doc --workspace --no-deps
          --exclude wraith-transfer
          --exclude wraith-chat
          --exclude wraith-sync
          --exclude wraith-share
          --exclude wraith-stream
          --exclude wraith-mesh
          --exclude wraith-publish
          --exclude wraith-vault
        env:
          RUSTDOCFLAGS: -Dwarnings

  #############################################################################
  # MSRV Check
  #############################################################################
  msrv:
    name: MSRV (1.88)
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsqlcipher-dev \
            libasound2-dev

      - name: Install Rust 1.88
        uses: dtolnay/rust-toolchain@1.88

      - name: Cache Cargo registry and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-msrv-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-msrv-
            ${{ runner.os }}-cargo-

      - name: Check MSRV
        run: >-
          cargo check --workspace
          --exclude wraith-transfer
          --exclude wraith-chat
          --exclude wraith-sync
          --exclude wraith-share
          --exclude wraith-stream
          --exclude wraith-mesh
          --exclude wraith-publish
          --exclude wraith-vault

  #############################################################################
  # Code Coverage
  #############################################################################
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsqlcipher-dev \
            libasound2-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache Cargo registry and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-cov-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cov-
            ${{ runner.os }}-cargo-test-
            ${{ runner.os }}-cargo-

      - name: Generate coverage report
        run: >-
          cargo llvm-cov --workspace --all-features
          --exclude wraith-transfer
          --exclude wraith-chat
          --exclude wraith-sync
          --exclude wraith-share
          --exclude wraith-stream
          --exclude wraith-mesh
          --exclude wraith-publish
          --exclude wraith-vault
          --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
